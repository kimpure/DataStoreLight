var Preact = require('preact')
var ref = require('tiny-atom/preact');
var ProvideAtom = ref.ProvideAtom;
var ConnectAtom = ref.ConnectAtom;
var ref$1 = require('./moonwave');
var moonwave = ref$1.moonwave;

function preactMoonwave (options) {
  var app = moonwave(options)
  app.render(render)
  app.unrender(unrender)
  return app
}

/**
 * Get the current route,
 * get the associated components,
 * render them in a nested fashion
 * and finally render the app into DOM
 */
var render = function (app) { return function (atom) {
  var router = app.router;
  var options = app.options;
  var route = atom.get().route
  var components = router.data(route.pattern).map(function (c) { return c.Component ? c.Component : c; })
  var App = components.reduceRight(function (children, Component) { return (
    Preact.h( Component, { state: atom.get(), split: atom.split, route: route }, children)
  ); }, null)
  Preact.render((
    Preact.h( ProvideRouter, { router: router },
      Preact.h( ProvideAtom, { atom: atom },
        App
      )
    )
  ), options.root, options.root.lastElementChild)
}; }

/**
 * Overwrite the target DOM element with nothing
 */
var unrender = function (app) {
  Preact.render(null, app.options.root, app.options.root.lastElementChild)
}

/**
 * It's useful to provide the router via context in case
 * someone wants to utilise router's functions such as
 * router.href()
 */
var ProvideRouter = (function (superclass) {
  function ProvideRouter () {
    superclass.apply(this, arguments);
  }

  if ( superclass ) ProvideRouter.__proto__ = superclass;
  ProvideRouter.prototype = Object.create( superclass && superclass.prototype );
  ProvideRouter.prototype.constructor = ProvideRouter;

  ProvideRouter.prototype.getChildContext = function getChildContext () {
    return {
      router: this.props.router
    }
  };

  ProvideRouter.prototype.render = function render () {
    return this.props.children[0]
  };

  return ProvideRouter;
}(Preact.Component));

module.exports = { moonwave: preactMoonwave, ProvideAtom: ProvideAtom, ConnectAtom: ConnectAtom, ProvideRouter: ProvideRouter }
